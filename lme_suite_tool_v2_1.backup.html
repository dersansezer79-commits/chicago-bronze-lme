<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Metals → Excel (GitHub Pages/RAW + TCMB FX)</title>
<meta name="robots" content="noindex,nofollow" />
<!-- CDN libs (work from GitHub Pages or file://). For fully offline, download locally and update src. -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.5.0/build/global/luxon.min.js"></script>
<style>
  :root{ --bg:#0b1020; --panel:#12182b; --ink:#e9eefb; --muted:#9fb0d6; --accent:#6aa3ff; --ok:#20c997; --warn:#ffc107; --bad:#ff6b6b;
    --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    --sans: Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--sans)}
  header{padding:16px 18px;border-bottom:1px solid #222a43;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .tag{font-size:12px;padding:3px 8px;border-radius:999px;background:#121a34;border:1px solid #2a3356;color:var(--muted)}
  main{max-width:1200px;margin:0 auto;padding:18px}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
  .card{background:var(--panel);border:1px solid #1e2742;border-radius:14px;padding:16px}
  h2{margin:0 0 12px;font-size:18px}
  table{width:100%;border-collapse:collapse}
  th,td{text-align:right;padding:8px 10px;border-bottom:1px solid #1c2440;font-variant-numeric:tabular-nums}
  th:first-child,td:first-child{text-align:left}
  thead th{position:sticky;top:0;background:linear-gradient(#182241,#12182b);border-bottom:1px solid #2c3a66}
  .mono{font-family:var(--mono);font-size:12px;color:#c4d3ff;word-break:break-all}
  .controls{display:flex;flex-wrap:wrap;gap:10px}
  button{cursor:pointer;padding:10px 14px;border-radius:10px;border:1px solid #2a3356;background:#182241;color:#e9eefb}
  button.primary{background:linear-gradient(180deg,#3a6cff,#2458ff);border-color:#2a5fff}
  button:disabled{opacity:.6;cursor:not-allowed}
  .small{font-size:12px;color:var(--muted)}
  @media (max-width:980px){.row{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <strong>Metals → Excel</strong>
  <span class="tag">GitHub Pages/RAW auto-fetch</span>
  <span class="tag">LME + WSJ/USA (USD/lb)</span>
  <span class="tag">TCMB FX (USDTRY, EURTRY, GBPTRY…)</span>
  <span class="tag">Exports .xlsx</span>
</header>

<main>
  <div class="row">
    <section class="card">
      <h2>Metals Preview</h2>
      <div class="small" id="metaInfo"></div>
      <table id="tblMetals">
        <thead>
          <tr>
            <th>Metal</th><th>USD/kg</th><th>USD/lb</th><th>TL/kg</th><th>Source</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:6px">Rounded for display; Excel keeps full precision.</div>
    </section>

    <aside class="card">
      <h2>Controls</h2>
      <div class="controls">
        <button id="btnReload">Reload data</button>
        <button id="btnExcel" class="primary" disabled>Generate Excel</button>
      </div>
      <div style="height:12px"></div>
      <div class="small">
        <div><b>lme.json:</b> <span class="mono" id="statLME">…</span></div>
        <div><b>tcmb.json:</b> <span class="mono" id="statFX">…</span></div>
        <div><b>alloys.json (optional):</b> <span class="mono" id="statAlloys">…</span></div>
      </div>
    </aside>
  </div>

  <div class="row" style="margin-top:18px">
    <section class="card">
      <h2>FX Preview (TCMB)</h2>
      <table id="tblFX">
        <thead><tr><th>Pair</th><th>Value</th><th>As of</th><th>Source</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="card">
      <h2>Raw (for quick debugging)</h2>
      <details>
        <summary>Show raw JSON</summary>
        <pre id="raw" class="mono"></pre>
      </details>
    </section>
  </div>
</main>

<script>
(() => {
  // ---------- REPO CONFIG ----------
  const USER = 'dersansezer79-commits';
  const REPO = 'chicago-bronze-lme';
  const BRANCH = 'main';

  // Build candidate URLs: prefer GitHub Pages (same-origin) → fallback to GitHub RAW
  const RAW = (p) => `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/${p}?nocache=${Date.now()}`;
  const PAGES = (p) => (location.origin && location.origin.startsWith('http')
    ? `${location.origin}/${REPO}/${p}?nocache=${Date.now()}`
    : null);
  const CANDIDATES = (p) => [PAGES(p), RAW(p)].filter(Boolean);

  async function fetchWithFallback(path) {
    const urls = CANDIDATES(path);
    for (const u of urls) {
      try {
        const r = await fetch(u, { cache: 'no-store' });
        if (!r.ok) continue;
        const j = await r.json();
        return { json: j, used: u };
      } catch (_) { /* try next */ }
    }
    throw new Error('All sources failed for ' + path);
  }

  // ---------- helpers ----------
  const LB_PER_KG = 2.20462262185;
  const fmt2 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 2 });
  const fmt3 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 3 });
  const fmt4 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 4 });
  const round = (v, n=3) => (v==null ? null : Math.round(v*10**n)/10**n);

  const el = (s) => document.querySelector(s);
  const $mBody = el('#tblMetals tbody');
  const $fxBody = el('#tblFX tbody');
  const $raw = el('#raw');
  const $metaInfo = el('#metaInfo');
  const $btnReload = el('#btnReload');
  const $btnExcel = el('#btnExcel');
  const $statLME = el('#statLME');
  const $statFX = el('#statFX');
  const $statAlloys = el('#statAlloys');

  let cache = { lme:null, fx:null, alloys:null, rows:[], wsjLb:null, usdtry:null, fxRows:[], srcLME:'', srcFX:'', srcAlloys:'' };

  function pickUSDTRY(lme, fx) {
    let val = lme?.meta?.usdtry ?? null;
    if (val == null && fx) val = Number(fx.USDTRY ?? fx.usdtry ?? null);
    return val ?? null;
  }

  function buildMetalRows(lme, usdtry) {
    const src = lme?.meta?.sources_used || {};
    const upk = lme?.usd_per_kg || {};
    const rows = [];
    const list = [
      ['Aluminum','aluminum'],
      ['Copper','copper'],
      ['Lead','lead'],
      ['Nickel','nickel'],
      ['Zinc','zinc']
    ];
    list.forEach(([label,key]) => {
      const v = Number(upk[key] ?? null);
      if (isFinite(v)) {
        rows.push({
          metal: label,
          usd_per_kg: v,
          usd_per_lb: v / LB_PER_KG,
          tl_per_kg: isFinite(usdtry) ? v * usdtry : null,
          source: src[key] || '—'
        });
      }
    });
    const wsjLb = lme?.benchmarks?.wsj_usa_copper_lb ?? null;
    if (wsjLb != null) {
      const wsjKg = lme?.benchmarks?.wsj_usa_copper_kg ?? (wsjLb * LB_PER_KG);
      rows.push({
        metal: 'WSJ/USA Copper (benchmark)',
        usd_per_kg: wsjKg,
        usd_per_lb: wsjLb,
        tl_per_kg: isFinite(usdtry) ? wsjKg * usdtry : null,
        source: lme?.meta?.sources_used?.wsj_usa_copper || 'wsj/comex'
      });
    }
    cache.wsjLb = wsjLb;
    return rows;
  }

  function buildFxRows(tcmb) {
    if (!tcmb) return [];
    const rows = [];
    const ignore = new Set(['as_of','source','field','updated_at','gold']);
    Object.keys(tcmb).forEach(k => {
      if (ignore.has(k)) return;
      const v = tcmb[k];
      if (typeof v === 'number' && isFinite(v)) {
        rows.push({ pair: k, value: v, as_of: tcmb.as_of || '', source: tcmb.source || '' });
      }
    });
    if (tcmb.gold && typeof tcmb.gold === 'object') {
      for (const [gk,gv] of Object.entries(tcmb.gold)) {
        if (gv != null && isFinite(gv)) {
          rows.push({ pair: `gold.${gk}`, value: gv, as_of: tcmb.as_of || '', source: tcmb.source || '' });
        }
      }
    }
    rows.sort((a,b) => (a.pair==='USDTRY'? -1 : b.pair==='USDTRY'? 1 : a.pair.localeCompare(b.pair)));
    return rows;
  }

  function renderPreview() {
    // Metals
    $mBody.innerHTML = '';
    cache.rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.metal}</td>
        <td>${fmt3.format(r.usd_per_kg)}</td>
        <td>${fmt4.format(r.usd_per_lb)}</td>
        <td>${r.tl_per_kg!=null ? fmt2.format(r.tl_per_kg) : '—'}</td>
        <td class="mono" style="font-size:11px">${r.source || ''}</td>
      `;
      $mBody.appendChild(tr);
    });

    // Meta line
    const ts = cache.lme?.timestamp || '—';
    const usdtry = cache.usdtry!=null ? fmt4.format(cache.usdtry) : '—';
    const wsj = cache.wsjLb!=null ? fmt4.format(cache.wsjLb) : '—';
    const srcL = cache.srcLME.replace(/^https:\/\//,'');
    const srcF = cache.srcFX.replace(/^https:\/\//,'');
    $metaInfo.innerHTML = `
      <div>Timestamp: <span class="mono">${ts}</span></div>
      <div>USD/TRY: <span class="mono">${usdtry}</span> | WSJ/USA (USD/lb): <span class="mono">${wsj}</span></div>
      <div class="small">LME source: <span class="mono">${srcL}</span><br/>FX source: <span class="mono">${srcF}</span></div>
    `;

    // FX
    $fxBody.innerHTML = '';
    cache.fxRows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.pair}</td>
        <td>${fmt4.format(r.value)}</td>
        <td class="mono">${r.as_of || ''}</td>
        <td class="mono">${r.source || ''}</td>
      `;
      $fxBody.appendChild(tr);
    });

    // Raw
    $raw.textContent = JSON.stringify(
      { lme: cache.lme, tcmb: cache.fx, usdtry: cache.usdtry },
      null, 2
    );

    $btnExcel.disabled = !(cache.rows.length && cache.fxRows.length);
  }

  async function loadAll() {
    try {
      $btnExcel.disabled = true;
      $statLME.textContent = 'loading…';
      $statFX.textContent  = 'loading…';
      $statAlloys.textContent = 'optional';

      const lme = await fetchWithFallback('lme_automation/lme.json');
      const fx  = await fetchWithFallback('lme_automation/tcmb.json');
      let alloys = null;
      try { alloys = await fetchWithFallback('specs/alloys.json'); } catch(_) { /* optional */ }

      cache.lme = lme.json; cache.srcLME = lme.used; $statLME.textContent = lme.used;
      cache.fx  = fx.json;  cache.srcFX  = fx.used;  $statFX.textContent  = fx.used;
      cache.alloys = alloys?.json || null; cache.srcAlloys = alloys?.used || ''; $statAlloys.textContent = alloys? alloys.used : 'not found (ok)';

      cache.usdtry = pickUSDTRY(cache.lme, cache.fx);
      cache.rows   = buildMetalRows(cache.lme, cache.usdtry);
      cache.fxRows = buildFxRows(cache.fx);

      renderPreview();
    } catch (e) {
      console.error(e);
      alert('Loading failed. Check console for details.');
    }
  }

  function makeWorkbook() {
    const now = luxon.DateTime.now().toISO();
    const wb = XLSX.utils.book_new();

    // Sheet: Metals
    const metalsAOA = [
      ['Metal','USD/kg','USD/lb','TL/kg','Source'],
      ...cache.rows.map(r => [
        r.metal,
        round(r.usd_per_kg,3),
        round(r.usd_per_lb,4),
        r.tl_per_kg!=null ? round(r.tl_per_kg,2) : null,
        r.source || ''
      ])
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(metalsAOA), 'Metals');

    // Sheet: Benchmarks
    const wsjLb = cache.wsjLb!=null ? round(cache.wsjLb,4) : null;
    const benchAOA = [
      ['Benchmark','Unit','Value','Source'],
      ['WSJ / USA Copper','USD/lb', wsjLb, cache.lme?.meta?.sources_used?.wsj_usa_copper || 'wsj/comex']
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(benchAOA), 'Benchmarks');

    // Sheet: FX (TCMB)
    const fxAOA = [
      ['Pair','Value','As of','Source'],
      ...cache.fxRows.map(r => [r.pair, r.value, r.as_of || '', r.source || ''])
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(fxAOA), 'FX');

    // Sheet: Raw (compact)
    const rawObj = {
      timestamp_now: now,
      lme_timestamp: cache.lme?.timestamp ?? null,
      lme_usdtry: cache.lme?.meta?.usdtry ?? null,
      tcmb_usdtry: cache.fx?.USDTRY ?? cache.fx?.usdtry ?? null,
      lme_source_url: cache.srcLME,
      tcmb_source_url: cache.srcFX
    };
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([rawObj], { origin:'A1' }), 'Raw');

    return wb;
  }

  function downloadExcel() {
    const dt = luxon.DateTime.now().toFormat('yyyy-LL-dd_HH-mm');
    const wb = makeWorkbook();
    XLSX.writeFile(wb, `Metals_${dt}.xlsx`, { compression: true });
  }

  $btnReload.addEventListener('click', loadAll);
  $btnExcel.addEventListener('click', downloadExcel);
  loadAll();
})();
</script>
</body>
</html>
